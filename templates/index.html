<!DOCTYPE html>
<html>
<head>
    <title>Trade Validator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Trade Validator</a>
        <a href="/dashboard" class="btn btn-outline-light btn-sm">Dashboard</a>
    </div>
</nav>

<div class="container mt-5">

<div class="card shadow-lg">
<div class="card-header bg-dark text-white text-center">
    <h3>Trade Validation System</h3>
</div>

<div class="card-body">

<!-- MODE TOGGLE -->
<div class="form-check form-switch mb-4 text-center">
    <input class="form-check-input" type="checkbox" id="modeToggle" checked>
    <label class="form-check-label">
        Use Remote Folder Mode
    </label>
</div>

<form id="validationForm">

<!-- FILE SECTION -->
<div id="fileSection" class="d-none">
    <div class="mb-3">
        <label>CE JSON File</label>
        <input type="file" class="form-control" id="ceFile">
    </div>
    <div class="mb-3">
        <label>PE JSON File</label>
        <input type="file" class="form-control" id="peFile">
    </div>
    <div class="mb-3">
        <label>Index JSON File</label>
        <input type="file" class="form-control" id="indexFile">
    </div>
</div>

<!-- FOLDER MODE SECTION -->
<div id="folderSection">

    <div class="mb-3">
        <label class="form-label">Folder Number</label>

        <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" id="minusBtn">âˆ’</button>

            <input type="number"
                   class="form-control text-center"
                   id="folderNumber"
                   value="1"
                   min="1"
                   placeholder="Enter folder number like 1,2,3">

            <button class="btn btn-outline-secondary" type="button" id="plusBtn">+</button>
        </div>

        <small class="text-muted">
            Reads from: uploads/folder_X/
        </small>
    </div>

</div>

<div class="d-grid">
    <button type="submit" class="btn btn-primary">
        Validate & Upload
    </button>
</div>

</form>

<div class="text-center mt-4">
    <div class="spinner-border text-primary d-none" id="loadingSpinner"></div>
</div>

<!-- RESULTS -->
<div id="resultSection" class="mt-4 d-none">

<div class="alert alert-success text-center">
    <h5>Validation Completed Successfully</h5>
</div>

<div class="card mb-3">
<div class="card-body">
    <h6>ğŸ“ Validation Folder</h6>
    <a id="folderUrl" target="_blank"></a>
</div>
</div>

<div class="card mb-3" id="matchedCard" style="display:none;">
<div class="card-body text-center">
    <h6>ğŸ“Š Matched Signals (Excel)</h6>
    <a id="matchedUrl" target="_blank" class="btn btn-success">
        Download Matched Signals
    </a>
</div>
</div>

<div class="card mb-3" id="matchedJsonCard" style="display:none;">
<div class="card-body text-center">
    <h6>ğŸ“„ Matched Signals (JSON)</h6>
    <a id="matchedJsonUrl" target="_blank" class="btn btn-info">
        Download JSON
    </a>
</div>
</div>

<div class="card mb-3" id="metaJsonCard" style="display:none;">
<div class="card-body text-center">
    <h6>ğŸ“Š Validation Meta (JSON)</h6>
    <a id="metaJsonUrl" target="_blank" class="btn btn-warning">
        Download Meta JSON
    </a>
</div>
</div>

<div class="card">
<div class="card-body">
    <h6>ğŸ“„ All Generated Files</h6>
    <table class="table table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>File</th>
                <th>Open</th>
            </tr>
        </thead>
        <tbody id="filesTableBody"></tbody>
    </table>
</div>
</div>

</div>
</div>
</div>

<script>

const toggle = document.getElementById("modeToggle");
const fileSection = document.getElementById("fileSection");
const folderSection = document.getElementById("folderSection");

toggle.addEventListener("change", function() {
    if (toggle.checked) {
        fileSection.classList.add("d-none");
        folderSection.classList.remove("d-none");
    } else {
        folderSection.classList.add("d-none");
        fileSection.classList.remove("d-none");
    }
});

/* ================================
   PLUS / MINUS FUNCTIONALITY
================================ */

const folderInput = document.getElementById("folderNumber");
const plusBtn = document.getElementById("plusBtn");
const minusBtn = document.getElementById("minusBtn");

plusBtn.addEventListener("click", function() {
    folderInput.stepUp();
});

minusBtn.addEventListener("click", function() {
    if (folderInput.value > 1) {
        folderInput.stepDown();
    }
});

document.getElementById("validationForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const spinner = document.getElementById("loadingSpinner");
    const resultSection = document.getElementById("resultSection");
    const filesTableBody = document.getElementById("filesTableBody");
    const matchedCard = document.getElementById("matchedCard");
    const matchedJsonCard = document.getElementById("matchedJsonCard");
    const metaJsonCard = document.getElementById("metaJsonCard");

    spinner.classList.remove("d-none");
    resultSection.classList.add("d-none");
    filesTableBody.innerHTML = "";

    matchedCard.style.display = "none";
    matchedJsonCard.style.display = "none";
    metaJsonCard.style.display = "none";

    let response;

    // ================= FILE MODE =================
    if (!toggle.checked) {

        const ceFile = document.getElementById("ceFile").files[0];
        const peFile = document.getElementById("peFile").files[0];
        const indexFile = document.getElementById("indexFile").files[0];

        if (!ceFile || !peFile || !indexFile) {
            alert("Upload all JSON files.");
            spinner.classList.add("d-none");
            return;
        }

        const ceData = await ceFile.text();
        const peData = await peFile.text();
        const indexData = await indexFile.text();

        response = await fetch("/validate", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                ce_data: JSON.parse(ceData),
                pe_data: JSON.parse(peData),
                index_data: JSON.parse(indexData)
            })
        });

    }
    // ================= FOLDER MODE =================
    else {

        const folderNum = document.getElementById("folderNumber").value;

        if (!folderNum) {
            alert("Enter folder number.");
            spinner.classList.add("d-none");
            return;
        }

        const baseRepo = "acc0012/save-remote-files";
        const basePath = `https://raw.githubusercontent.com/${baseRepo}/main/uploads/folder_${folderNum}`;

        response = await fetch("/validate-from-github", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                ce_url: `${basePath}/ce_all_trades.json`,
                pe_url: `${basePath}/pe_all_trades.json`,
                index_url: `${basePath}/index_all_trades.json`
            })
        });
    }

    const result = await response.json();
    spinner.classList.add("d-none");

    if (result.status === "success") {

        document.getElementById("folderUrl").href = result.folder_url;
        document.getElementById("folderUrl").innerText = result.folder_url;

        if (result.matched_signals_url) {
            matchedCard.style.display = "block";
            document.getElementById("matchedUrl").href = result.matched_signals_url;
        }

        if (result.matched_json_url) {
            matchedJsonCard.style.display = "block";
            document.getElementById("matchedJsonUrl").href = result.matched_json_url;
        }

        if (result.meta_json_url) {
            metaJsonCard.style.display = "block";
            document.getElementById("metaJsonUrl").href = result.meta_json_url;
        }

        result.files.forEach((fileUrl, index) => {

            const fileName = fileUrl.split("/").pop();

            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${fileName}</td>
                    <td>
                        <a href="${fileUrl}" target="_blank"
                           class="btn btn-sm btn-outline-primary">
                            Open
                        </a>
                    </td>
                </tr>
            `;

            filesTableBody.innerHTML += row;
        });

        resultSection.classList.remove("d-none");

    } else {
        alert("Error: " + result.error);
    }
});

</script>

</body>
</html>